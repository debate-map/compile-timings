name: Extract data from build timing html files and perform react deployment

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  linux-ubuntu:
    name: Extract timing information from new build timing html files
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          path: compile-timings
      - name: Extract JSON out of build timing
        working-directory: compile-timings
        run: |
          mkdir -p docs/timings/build_metadatas
          mkdir -p docs/timings/build_units
          cd compile_timing_extractor
          cargo run -- -r ../docs/timings/raw_html -t ../docs/timings/tracker.json -m ../docs/timings/build_metadatas/ -u ../docs/timings/build_units

      - name: Commit and push changes
        working-directory: compile-timings
        run: |
          git config user.name "compile-timings[bot]"
          git config user.email debatemap@gmail.com
          git diff --quiet && echo "No changes to commit" || {
            git add docs/timings
            git commit -m "[skip ci]: generate JSON from build timing html files"
            git push
          }
